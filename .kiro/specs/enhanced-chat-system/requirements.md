# 增強聊天系統需求文檔

## 介紹

Simple RAG 系統的聊天功能需要增強，以提供更強大的對話體驗。當前系統支持基於 RAG 的問答，但缺乏多輪對話上下文管理、對話模式切換、以及高級功能如對話分支、反饋機制等。本需求文檔定義了增強聊天系統的功能需求。

## 詞彙表

- **Chat Session**: 一個獨立的對話會話，包含多輪用戶和助手的交互
- **Context Window**: 在生成回答時考慮的歷史消息數量
- **Chat Mode**: 對話模式，包括 RAG 模式（基於文檔）和 Free Chat 模式（純 LLM）
- **Message Feedback**: 用戶對助手回答的評價（點讚/點踩）
- **Conversation Branch**: 從某個消息點創建的新對話分支
- **LLM Service**: 語言模型服務，支持多個 LLM 提供商（Ollama、Azure OpenAI、Gemini）
- **Vector Store**: 向量數據庫，用於存儲和檢索文檔嵌入

## 需求

### 需求 1

**用戶故事**: 作為用戶，我想在對話中切換 RAG 模式和自由聊天模式，以便根據需要選擇是否使用文檔作為參考。

#### 驗收標準

1. WHEN 用戶在對話中設置 `use_rag=true` THEN 系統 SHALL 搜索相關文檔並將其作為上下文提供給 LLM
2. WHEN 用戶在對話中設置 `use_rag=false` THEN 系統 SHALL 直接調用 LLM 而不搜索任何文檔
3. WHEN 用戶切換模式 THEN 系統 SHALL 保持對話歷史不變並在下一條消息中應用新模式
4. WHEN 用戶查詢對話詳情 THEN 系統 SHALL 返回每條消息的模式信息（RAG 或 Free Chat）

### 需求 2

**用戶故事**: 作為用戶，我想在對話中保持完整的上下文，以便 LLM 能夠理解多輪對話的連貫性。

#### 驗收標準

1. WHEN 用戶發送新消息到現有對話 THEN 系統 SHALL 將最近的 N 條消息作為上下文發送給 LLM
2. WHEN 對話消息數量超過上下文窗口大小 THEN 系統 SHALL 保留最新的消息並丟棄最舊的消息
3. WHEN 生成回答時 THEN 系統 SHALL 在 LLM 提示中包含完整的對話歷史上下文
4. WHEN 用戶查詢對話詳情 THEN 系統 SHALL 返回所有消息的完整歷史記錄

### 需求 3

**用戶故事**: 作為用戶，我想對助手的回答進行反饋（點讚/點踩），以便幫助系統改進。

#### 驗收標準

1. WHEN 用戶對消息進行點讚 THEN 系統 SHALL 記錄該反饋並將其存儲在數據庫中
2. WHEN 用戶對消息進行點踩 THEN 系統 SHALL 記錄該反饋並將其存儲在數據庫中
3. WHEN 用戶查詢消息詳情 THEN 系統 SHALL 返回該消息的反饋狀態（未反饋、點讚、點踩）
4. IF 用戶嘗試對同一消息進行多次反饋 THEN 系統 SHALL 更新為最新的反饋狀態

### 需求 4

**用戶故事**: 作為用戶，我想從對話中的任何消息點創建新的對話分支，以便探索不同的對話路徑。

#### 驗收標準

1. WHEN 用戶從某個消息創建分支 THEN 系統 SHALL 創建新的對話會話，包含到該消息為止的所有消息
2. WHEN 用戶在分支中發送新消息 THEN 系統 SHALL 將新消息添加到分支而不影響原始對話
3. WHEN 用戶查詢對話列表 THEN 系統 SHALL 顯示分支對話及其父對話的關係
4. WHEN 用戶刪除原始對話 THEN 系統 SHALL 保留所有分支對話

### 需求 5

**用戶故事**: 作為用戶，我想搜索對話歷史中的特定內容，以便快速找到相關的對話。

#### 驗收標準

1. WHEN 用戶搜索對話內容 THEN 系統 SHALL 返回所有包含搜索關鍵詞的對話會話
2. WHEN 用戶搜索對話 THEN 系統 SHALL 在對話標題和消息內容中進行搜索
3. WHEN 搜索結果為空 THEN 系統 SHALL 返回空列表而不是錯誤
4. WHEN 用戶搜索對話 THEN 系統 SHALL 按相關性排序結果

### 需求 6

**用戶故事**: 作為系統，我想序列化和反序列化對話數據，以便正確存儲和檢索對話歷史。

#### 驗收標準

1. WHEN 對話被保存到數據庫 THEN 系統 SHALL 將消息列表序列化為 JSON 格式
2. WHEN 對話從數據庫檢索 THEN 系統 SHALL 將 JSON 反序列化為消息對象
3. WHEN 序列化後反序列化對話 THEN 系統 SHALL 返回與原始對話相同的數據結構
4. WHEN 對話包含特殊字符或 Unicode THEN 系統 SHALL 正確處理序列化和反序列化

### 需求 7

**用戶故事**: 作為用戶，我想查看對話中每條消息的元數據，以便了解消息的詳細信息。

#### 驗收標準

1. WHEN 用戶查詢消息詳情 THEN 系統 SHALL 返回消息的角色（user/assistant）、內容、時間戳和模式
2. WHEN 消息是 RAG 模式生成 THEN 系統 SHALL 返回相關的文檔來源信息
3. WHEN 消息包含反饋 THEN 系統 SHALL 返回反饋狀態和時間戳
4. WHEN 消息是分支的起點 THEN 系統 SHALL 返回分支對話的 ID

### 需求 8

**用戶故事**: 作為用戶，我想導出對話為不同格式，以便在其他應用中使用。

#### 驗收標準

1. WHEN 用戶請求導出對話為 JSON THEN 系統 SHALL 返回完整的對話數據結構
2. WHEN 用戶請求導出對話為 Markdown THEN 系統 SHALL 返回格式化的 Markdown 文本
3. WHEN 用戶請求導出對話為 PDF THEN 系統 SHALL 返回可下載的 PDF 文件
4. WHEN 導出對話 THEN 系統 SHALL 包含所有消息、元數據和反饋信息
